# docker-compose.yml (self-contained for devsys)
# version 3.1 works with Docker Swarm / Compose‑file‑v3
#version: '3.1'

services:
  # n8n service removed for PoC; original n8n config was here
  # (if you need it again, it can be restored from project history)

  # ----------  PHP web‑server repurposed as local deployment target ----------
  php:
    build:
      context: .
      dockerfile: Dockerfile.php
    restart: unless-stopped
    ports:
      # Host port 8081 serves HTTP for deployed apps (change as needed)
      - "127.0.0.1:8081:80"
      # SSH kept for admin access inside the container
      - "127.0.0.1:2223:22"
    volumes:
      # Mount a deploy folder that agents will write into; container will symlink the current app into /var/www/html
      - ./workspace/deploy:/var/www/deploy:rw
      # Optional static content directory (fallback) served from workspace so agents can update it
      - ./workspace/www:/var/www/www:rw

  manager:
    build: ./manager
    container_name: devsys_manager
    ports:
      - "8080:8080"
    volumes:
      - ./workspace:/workspace
    environment:
      - WORKSPACE=/workspace

  coding-agent:
    build: ./coding-agent
    container_name: devsys_coding_agent
    depends_on:
      - manager
    volumes:
      - ./workspace:/workspace
    environment:
      - MANAGER_URL=http://manager:8080
      - WORKSPACE=/workspace

  deployment-agent:
    build: ./deployment-agent
    container_name: devsys_deployment_agent
    depends_on:
      - manager
    volumes:
      - ./workspace:/workspace
    environment:
      - MANAGER_URL=http://manager:8080
      - WORKSPACE=/workspace
