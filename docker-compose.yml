version: '3.8'

services:
  manager:
    build: ./manager
    container_name: devsys_manager
    ports:
      - "8080:8080"
    volumes:
      - ./workspace:/workspace
    environment:
      - WORKSPACE=/workspace

  coding-agent:
    build: ./coding-agent
    container_name: devsys_coding_agent
    depends_on:
      - manager
    volumes:
      - ./workspace:/workspace
    environment:
      - MANAGER_URL=http://manager:8080
      - WORKSPACE=/workspace
      - MANAGER_API_TOKEN=${MANAGER_API_TOKEN}

  deployment-agent:
    build: ./deployment-agent
    container_name: devsys_deployment_agent
    depends_on:
      - manager
    volumes:
      - ./workspace:/workspace
      # Example: mount SSH private key from host secrets into the container
      # - ./secrets/external_deploy_key:/run/secrets/external_deploy_key:ro
    env_file:
      - .env
    environment:
      - MANAGER_URL=http://manager:8080
      - WORKSPACE=/workspace
      - MANAGER_API_TOKEN=${MANAGER_API_TOKEN}
      - EXTERNAL_DEPLOY_SSH_KEY=/run/secrets/external_deploy_key
      - EXTERNAL_DEPLOY_KNOWN_HOSTS=/run/secrets/external_deploy_known_hosts

  testing-agent:
    build: ./testing-agent
    container_name: devsys_testing_agent
    depends_on:
      - manager
    volumes:
      - ./workspace:/workspace
      # Example: mount SSH private key for remote test host
      # - ./secrets/remote_test_key:/run/secrets/remote_test_key:ro
    env_file:
      - .env
    environment:
      - MANAGER_URL=http://manager:8080
      - WORKSPACE=/workspace
      - REMOTE_TEST_SSH_KEY=/run/secrets/remote_test_key
      - REMOTE_TEST_KNOWN_HOSTS=/run/secrets/remote_known_hosts

  monitoring-agent:
    build: ./monitoring-agent
    container_name: devsys_monitoring_agent
    depends_on:
      - manager
    volumes:
      - ./workspace:/workspace
      - ./monitoring:/monitoring:ro
    env_file:
      - .env
    environment:
      - MANAGER_URL=http://manager:8080
      - WORKSPACE=/workspace
      - CHECKS_FILE=/monitoring/checks.yaml

  php:
    build:
      context: .
      dockerfile: Dockerfile.php
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - WORKSPACE=/workspace
    ports:
      - "127.0.0.1:8081:80"
      - "127.0.0.1:2223:22"
    volumes:
      - ./workspace:/workspace
      - ./workspace/deploy:/var/www/deploy:rw
      - ./workspace/www:/var/www/www:rw
      # Mount the vocaloid app into the web root
      - ./apps/vocaloid:/var/www/www/vocaloid:ro

  renderer:
    build: ./renderer
    container_name: devsys_renderer
    depends_on:
      - php
    env_file:
      - .env
    volumes:
      - ./workspace:/workspace
    environment:
      - WORKSPACE=/workspace
      - OLLAMA_URL=${OLLAMA_URL}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - OLLAMA_KEY=${OLLAMA_KEY}
