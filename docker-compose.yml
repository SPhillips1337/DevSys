version: '3.8'

services:
  manager:
    build: ./manager
    container_name: devsys_manager
    ports:
      - "8080:8080"
    volumes:
      - ./workspace:/workspace
    environment:
      - WORKSPACE=/workspace

  coding-agent:
    build: ./coding-agent
    container_name: devsys_coding_agent
    depends_on:
      - manager
    volumes:
      - ./workspace:/workspace
    environment:
      - MANAGER_URL=http://manager:8080
      - WORKSPACE=/workspace
      - MANAGER_API_TOKEN=${MANAGER_API_TOKEN}

  deployment-agent:
    build: ./deployment-agent
    container_name: devsys_deployment_agent
    depends_on:
      - manager
    volumes:
      - ./workspace:/workspace
    environment:
      - MANAGER_URL=http://manager:8080
      - WORKSPACE=/workspace
      - MANAGER_API_TOKEN=${MANAGER_API_TOKEN}

  testing-agent:
    build: ./testing-agent
    container_name: devsys_testing_agent
    depends_on:
      - manager
    volumes:
      - ./workspace:/workspace
    env_file:
      - .env
    environment:
      - MANAGER_URL=http://manager:8080
      - WORKSPACE=/workspace

  monitoring-agent:
    build: ./monitoring-agent
    container_name: devsys_monitoring_agent
    depends_on:
      - manager
    volumes:
      - ./workspace:/workspace
      - ./monitoring:/monitoring:ro
    env_file:
      - .env
    environment:
      - MANAGER_URL=http://manager:8080
      - WORKSPACE=/workspace
      - CHECKS_FILE=/monitoring/checks.yaml

  php:
    build:
      context: .
      dockerfile: Dockerfile.php
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "127.0.0.1:8081:80"
      - "127.0.0.1:2223:22"
    volumes:
      - ./workspace/deploy:/var/www/deploy:rw
      - ./workspace/www:/var/www/www:rw
