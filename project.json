{
  "schemaVersion": "1.0.0",
  "name": "devsys-opencode-php-ssh",
  "slug": "devsys-opencode-php-ssh",
  "summary": "Developer-in-a-box PoC: multi-agent environment (manager, coding, testing, deployment, monitoring) that accepts user stories, runs opencode-like scaffolding, tests, deploys, and verifies artifacts.",
  "version": "0.2.2",
  "license": "MIT",
  "repository": "https://github.com/stephen/devsys-opencode-php-ssh",
  "goals": [
    "Provide a standalone devsys environment for agent-driven development workflows",
    "Demonstrate manager → coding → testing → deployment → monitoring automated flow with task handoffs",
    "Offer a reproducible PoC for autonomous task execution with acceptance checks and test reporting"
  ],
  "primary_features": [
    "Docker Compose manifest for agent services and PHP deployment target",
    "Manager HTTP API for task creation and lifecycle management (with optional token auth)",
    "Coding, Testing, Deployment and Monitoring agents to run the full pipeline",
    "Remote-ssh runner for remote test/deploy execution (known_hosts enforced)"
  ],
  "tech_stack": {
    "orchestration": "Docker Compose",
    "container_base_image": "php:8.2-apache (for deployment target) / python:3.11-slim (agents)",
    "service_manager_in_container": "Supervisor (optional runtime), simple entrypoint scripts",
    "opencode": "opencode (invoked by coding-agent where available)"
  },
  "security_considerations": [
    "Hardcoded credentials removed from Dockerfile; runtime .env provides N8N_USER_PASSWORD and N8N_USER_PUBKEY — do not commit .env",
    "Temporary private key earlier referenced should be removed from host after copying to clients",
    "SSH host port remapped to 2223 for this PoC; ensure firewall rules and restrict exposure",
    "Manager API may be protected with MANAGER_API_TOKEN — use strong secrets and consider Docker secrets for production",
    "Remote SSH operations require a known_hosts file by default; set REMOTE_ALLOW_INSECURE_SSH only for short-lived PoC testing"
  ],
  "development_state": {
    "scaffold": "PoC",
    "notes": "Manager, coding-agent, testing-agent, deployment-agent and monitoring-agent implemented. Remote-ssh runner, runner helper, sample manifest and basic CI added. Remaining: full spec-kit integration, persistent DB, notification hooks, RBAC."
  },
  "development_plan": {
    "currentPhase": 2,
    "phases": [
      { "number": 1, "name": "Extract and verify", "description": "Copy minimal files out of the n8n repo and verify container builds" },
      { "number": 2, "name": "PoC agents", "description": "Add manager, coding-agent, deployment-agent, testing-agent and monitoring-agent and basic task flow" },
      { "number": 3, "name": "Hardening & features", "description": "Add spec-kit, persistent stores, RBAC, notifications and CI" }
    ]
  },
  "todo": [
    { "id": "1", "title": "Integrate spec-kit validators into manager (full toolchain)", "status": "pending", "priority": "high" },
    { "id": "2", "title": "Add notification hooks (Slack/webhook/email)", "status": "pending", "priority": "medium" },
    { "id": "3", "title": "Migrate task store to Postgres and add Redis queues", "status": "pending", "priority": "medium" },
    { "id": "4", "title": "Add RBAC and per-agent tokens", "status": "pending", "priority": "medium" },
    { "id": "5", "title": "Document remote runner provisioning and Docker secrets examples", "status": "completed", "priority": "low" }
  ],
  "files_of_interest": ["docker-compose.yml","Dockerfile.php","README.md","manager/app.py","deployment-agent/worker.py","testing-agent/worker.py","monitoring-agent/worker.py","utils/runner.py",".github/workflows/ci.yml","specs/create-blog.json"],
  "open_questions": [
    "Do you want opencode bundled into its own container or kept inside the coding-agent?",
    "What level of autonomy should monitoring/auto-repair have? (auto-fix vs create task)"
  ],
  "contact": { "maintainer": "stephen", "location": "local host" },
  "how_to_run_locally": {
    "summary": "Build and run the devsys compose stack and use the manager API to create tasks",
    "steps": [
      "cd /home/stephen/devsys",
      "Copy .env.example to .env and set secrets (N8N_USER_PASSWORD, MANAGER_API_TOKEN) — do not commit .env",
      "docker compose up -d --build",
      "Check manager API: http://localhost:8080/api/tasks",
      "Create a task (example): curl -X POST http://localhost:8080/api/tasks -H 'Content-Type: application/json' -d '{\"id\":\"task-001\",\"title\":\"Create blog\",\"owner\":\"manager\",\"kind\":\"deployment\",\"deploy\":true}'",
      "Trigger deploy: POST /api/tasks/<id>/deploy",
      "Dev site served at http://localhost:8081 (PHP container)",
      "Monitor health via monitoring-agent: checks defined in monitoring/checks.yaml"
    ],
    "environment": { "MANAGER_PORT": "8080", "DEPLOYMENT_HTTP_PORT": "8081", "SSH_PORT": "2223" }
  },
  "lastUpdated": "2025-11-25T12:00:00Z",
  "api_endpoints": [
    { "endpoint": "/api/tasks", "method": "POST", "description": "Create a task from a user story" },
    { "endpoint": "/api/tasks/<id>/deploy", "method": "POST", "description": "Mark task ready_for_deploy so deployment-agent will deploy it" },
    { "endpoint": "/api/tasks/<id>/rollback", "method": "POST", "description": "Rollback a task deployment to a previous revision" },
    { "endpoint": "/api/tasks/<id>/tests/latest", "method": "GET", "description": "Fetch latest test report and summary for a task" }
  ],
  "external_services": { "opencode_installer": "https://opencode.ai/install" },
  "required_env": ["Docker & Docker Compose installed on host","Create a local .env from .env.example to set runtime secrets","REMOTE_*_KNOWN_HOSTS or REMOTE_ALLOW_INSECURE_SSH for remote-ssh operations if used"],
  "current_capabilities": ["Manage tasks via manager API","Scaffold simple sites via coding-agent","Run tests via testing-agent with JUnit/XML reports","Deploy artifacts and verify via deployment-agent","Monitor services and create follow-up tasks via monitoring-agent","Remote-ssh deploys and remote test execution (known_hosts enforced)","CI workflow for manifest/tests (.github/workflows/ci.yml)"] ,
  "next_steps": ["Finish spec-kit integration","Add notification hooks and RBAC","Migrate task store to Postgres/Redis"],
  "architecture": { "overview": "Docker Compose with agent services (manager, coding-agent, testing-agent, deployment-agent, monitoring-agent) and a PHP container as local deployment target.",
    "components": {
      "manager": { "description": "Task manager and API", "implementation": "manager/app.py", "files": ["manager/app.py","manager/task_schema.json"], "status": "ready" },
      "coding-agent": { "description": "Scaffolds code/artifacts from task specs", "implementation": "coding-agent/worker.py", "files": ["coding-agent/worker.py"], "status": "ready" },
      "testing-agent": { "description": "Runs tests and produces JUnit/XML reports", "implementation": "testing-agent/worker.py", "files": ["testing-agent/worker.py"], "status": "ready" },
      "deployment-agent": { "description": "Deploys task artifacts and verifies acceptance", "implementation": "deployment-agent/worker.py", "files": ["deployment-agent/worker.py"], "status": "ready" },
      "monitoring-agent": { "description": "Performs health checks and creates follow-up tasks on failures", "implementation": "monitoring-agent/worker.py", "files": ["monitoring-agent/worker.py","monitoring/checks.yaml"], "status": "ready" },
      "php": { "description": "PHP Apache container used as a local deployment target", "implementation": "Dockerfile.php", "files": ["Dockerfile.php","entrypoint.sh"], "status": "ready" }
    }
  },
  "infrastructure": { "type": "docker-compose", "notes": "Compose references ./workspace for shared artifacts and ./workspace/www for served content", "files": ["docker-compose.yml"] },
  "status": "poc",
  "concept": "Agent-driven developer-in-a-box for rapid prototyping and automated task handoffs",
  "current_goals": ["Finish spec-kit integration","Add notification hooks","Harden API and secrets management"],
  "key_files": { "compose": "docker-compose.yml", "dockerfile_php": "Dockerfile.php", "readme": "README.md" }
}
